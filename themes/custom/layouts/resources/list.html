{{- define "main" }}

<style>
  @media screen and (max-width: 768px) {
    .post-entry[style*="display: flex"] {
      flex-direction: column !important;
    }
    .entry-cover[style*="width: 160px"] {
      width: 100% !important;
      max-width: 200px !important;
      margin: 0 auto var(--gap) auto !important;
    }
  }
  .table-of-contents {
    background: var(--theme);
    border-radius: 8px;
    padding: 24px;
    margin-top: calc(var(--gap) * 2);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }
  .table-of-contents h2 {
    margin-top: 0;
    margin-bottom: 20px;
    font-size: 1.5em;
    color: var(--primary);
  }
  .table-of-contents-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .table-of-contents-list a {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 0 5px;
    color: var(--primary);
    text-decoration: none;
    border-radius: 6px;
    transition: all 0.2s ease;
    background: transparent;
  }
  .table-of-contents-list a:hover {
    background: var(--code-bg);
    transform: translateX(4px);
  }
  .table-of-contents-list a .chapter-number {
    color: var(--secondary);
    font-size: 0.9em;
    font-weight: 500;
    min-width: 40px;
    opacity: 0.7;
  }
  .table-of-contents-list a .chapter-title {
    flex: 1;
  }
  .table-of-contents-list a .chapter-reading-time {
    color: var(--secondary);
    font-size: 0.85em;
    text-align: right;
    opacity: 0.7;
  }
</style>

{{- /* Détecter si on est dans une sous-section (un livre individuel) */}}
{{- $isBookSection := and (eq .Section "resources") (ne .RelPermalink "/resources/") (eq (len .Sections) 0) }}

{{- if $isBookSection }}
  {{- /* Affichage pour une page de livre individuel */}}
  <article class="post-single">
    <header class="post-header">
      {{ partial "breadcrumbs.html" . }}
      <h1 class="post-title entry-hint-parent">
        {{ .Title }}
        {{- if .Draft }}
        <span class="entry-hint" title="Draft">
          <svg xmlns="http://www.w3.org/2000/svg" height="35" viewBox="0 -960 960 960" fill="currentColor">
            <path
              d="M160-410v-60h300v60H160Zm0-165v-60h470v60H160Zm0-165v-60h470v60H160Zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22q0 11-4.5 22.5T862.09-380L643-160H520Zm300-263-37-37 37 37ZM580-220h38l121-122-18-19-19-18-122 121v38Zm141-141-19-18 37 37-18-19Z" />
          </svg>
        </span>
        {{- end }}
      </h1>
      {{- if .Description }}
      <div class="post-description">
        {{ .Description }}
      </div>
      {{- end }}
    </header>

    {{- if .Content }}
    <div class="post-content">
      {{- if not (.Param "disableAnchoredHeadings") }}
      {{- partial "anchored_headings.html" .Content -}}
      {{- else }}{{ .Content }}{{ end }}
    </div>
    {{- end }}

    {{- /* Récupérer toutes les pages régulières du livre dans l'ordre */}}
    {{- $allPages := .RegularPagesRecursive }}
    {{- if not $allPages }}
      {{- $allPages = .RegularPages }}
    {{- end }}
    
    {{- /* Trier les pages : d'abord par poids, puis par chemin de fichier */}}
    {{- $sortedPages := sort $allPages "Weight" "asc" }}
    {{- $sortedPages = sort $sortedPages "File.Path" "asc" }}
    
    {{- /* Calculer le temps de lecture total */}}
    {{- $totalReadingTime := 0 }}
    {{- range $sortedPages }}
      {{- $totalReadingTime = add $totalReadingTime .ReadingTime }}
    {{- end }}
    
    {{- /* Afficher la liste des chapitres */}}
    {{- if gt (len $sortedPages) 0 }}
    <div class="table-of-contents">
      <h2>
        Table des matières
        {{- if gt $totalReadingTime 0 }}
        {{- $hours := div $totalReadingTime 60 }}
        {{- $minutes := mod $totalReadingTime 60 }}
        <span style="font-size: 0.6em; font-weight: normal; color: var(--secondary); margin-left: 12px;">
          (environ
          {{- if gt $hours 0 }}
            {{ $hours }}h
            {{- if gt $minutes 0 }} {{ $minutes }}min{{ end }}
          {{- else }}
            {{ $minutes }}min
          {{- end }}
          de lecture en prenant son temps)
        </span>
        {{- end }}
      </h2>
      <ul class="table-of-contents-list">
        {{- range $sortedPages }}
        <li>
          <a href="{{ .Permalink }}">
            <span class="chapter-number">{{ .File.LogicalName | replaceRE "^([0-9.]+)-.*" "$1" }}</span>
            <span class="chapter-title">{{ .Title }}</span>
            {{- if gt .ReadingTime 0 }}
            <span class="chapter-reading-time">{{ .ReadingTime }} {{ cond (eq .ReadingTime 1) "min" "min" }}</span>
            {{- end }}
          </a>
        </li>
        {{- end }}
      </ul>
    </div>
    
    {{- /* Navigation vers le premier chapitre */}}
    {{- $firstPage := index $sortedPages 0 }}
    <nav class="paginav" style="margin-top: calc(var(--gap) * 2);">
      <a class="next" href="{{ $firstPage.Permalink }}" style="width: 100%; text-align: center;">
        <span class="title">Commencer la lecture »</span>
        <br>
        <span>{{ $firstPage.Title }}</span>
      </a>
    </nav>
    {{- end }}
  </article>
{{- else }}
  {{- /* Affichage pour la page principale /resources/ */}}
  <header class="page-header">
    {{- partial "breadcrumbs.html" . }}
    <h1>
      {{ .Title }}
    </h1>
    {{- if .Description }}
    <div class="post-description">
      {{ .Description | markdownify }}
    </div>
    {{- end }}
  </header>

  {{- if .Content }}
  <div class="post-content">
    {{- if not (.Param "disableAnchoredHeadings") }}
    {{- partial "anchored_headings.html" .Content -}}
    {{- else }}{{ .Content }}{{ end }}
  </div>
  {{- end }}

  {{- /* Récupérer les livres depuis les métadonnées */}}
  {{- $livresConfig := .Params.livres | default slice }}

{{- /* Créer un dictionnaire des sections disponibles */}}
{{- $sectionsMap := dict }}
{{- range .Sections }}
  {{- $sectionSlug := path.Base .RelPermalink }}
  {{- $sectionsMap = merge $sectionsMap (dict $sectionSlug .) }}
{{- end }}

{{- if $livresConfig }}
  {{- range $livresConfig }}
    {{- /* Trouver la section : d'abord dans le dictionnaire, puis avec site.GetPage */}}
    {{- $section := index $sectionsMap .slug }}
    
    {{- if not $section }}
      {{- $sectionPath1 := printf "/resources/%s" .slug }}
      {{- $section = site.GetPage $sectionPath1 }}
    {{- end }}
    {{- if not $section }}
      {{- $sectionPath2 := printf "/resources/%s/" .slug }}
      {{- $section = site.GetPage $sectionPath2 }}
    {{- end }}
    
    {{- /* Afficher le livre même si la section n'est pas trouvée, en utilisant les métadonnées */}}
    {{- if $section }}
      {{- /* Compter toutes les pages régulières récursivement */}}
      {{- $chapitres := $section.RegularPagesRecursive | default $section.RegularPages }}
      {{- $nbChapitres := len $chapitres }}
      
      {{- /* Trouver la date de dernière modification */}}
      {{- $lastModified := $section.Lastmod }}
      {{- range $chapitres }}
        {{- if gt .Lastmod $lastModified }}
          {{- $lastModified = .Lastmod }}
        {{- end }}
      {{- end }}
      
      {{- /* Calculer le temps de lecture total pour la section */}}
      {{- $sectionReadingTime := 0 }}
      {{- range $chapitres }}
        {{- $sectionReadingTime = add $sectionReadingTime .ReadingTime }}
      {{- end }}
      
      {{- /* Chercher une image de couverture */}}
      {{- $coverImage := "" }}
      {{- $coverImageName := "" }}
      
      {{- /* 1. Vérifier les métadonnées de couverture dans le _index.md de la section */}}
      {{- if $section.Params.cover.image }}
        {{- $coverImageName = $section.Params.cover.image }}
      {{- else if .cover.image }}
        {{- /* 2. Vérifier les métadonnées de couverture dans la config du livre */}}
        {{- $coverImageName = .cover.image }}
      {{- end }}
      
      {{- if $coverImageName }}
        {{- /* Chercher l'image dans les ressources de la section */}}
        {{- $coverResource := $section.Resources.Get $coverImageName }}
        {{- if not $coverResource }}
          {{- $matchedResources := $section.Resources.Match $coverImageName }}
          {{- if $matchedResources }}
            {{- $coverResource = index $matchedResources 0 }}
          {{- end }}
        {{- end }}
        {{- if $coverResource }}
          {{- $coverImage = $coverResource.Permalink }}
        {{- else }}
          {{- /* Chercher dans assets/livres/ */}}
          {{- $globalCover := resources.Get (printf "livres/%s" $coverImageName) }}
          {{- if $globalCover }}
            {{- $coverImage = $globalCover.Permalink }}
          {{- else }}
            {{- /* Fallback vers le chemin relatif */}}
            {{- $coverImage = (printf "/livres/%s" $coverImageName) | absURL }}
          {{- end }}
        {{- end }}
      {{- else }}
        {{- /* 3. Si pas de métadonnées, chercher dans les ressources comme avant */}}
        {{- $coverInIllustrations := $section.Resources.Match "illustrations/cover.*" }}
        {{- if $coverInIllustrations }}
          {{- $coverResource := index $coverInIllustrations 0 }}
          {{- $coverImage = $coverResource.Permalink }}
        {{- else }}
          {{- $illustrations := $section.Resources.Match "illustrations/*" }}
          {{- if $illustrations }}
            {{- $coverResource := index $illustrations 0 }}
            {{- $coverImage = $coverResource.Permalink }}
          {{- else }}
            {{- $coverFiles := $section.Resources.Match "*cover*" }}
            {{- if $coverFiles }}
              {{- $coverResource := index $coverFiles 0 }}
              {{- $coverImage = $coverResource.Permalink }}
            {{- end }}
          {{- end }}
        {{- end }}
      {{- end }}
      
      {{- /* Utiliser les informations des métadonnées ou de la section */}}
      {{- $titre := .title | default $section.Title }}
      {{- $description := .description | default $section.Description | default $section.Summary }}
      {{- $lien := $section.Permalink }}
    
    <article class="post-entry" style="display: flex; gap: var(--gap); align-items: flex-start; margin-bottom: var(--gap);">
      {{- if $coverImage }}
      <figure class="entry-cover" style="flex-shrink: 0; width: 160px; margin: 0;">
        <img loading="lazy" src="{{ $coverImage }}" alt="{{ $titre | plainify }}" style="width: 100%; height: auto; border-radius: 4px; display: block;">
      </figure>
      {{- end }}
      <div style="flex: 1; min-width: 0;">
        <header class="entry-header">
          <h2 class="entry-hint-parent" style="gap: 12px; align-items: baseline;">
            <a href="{{ $lien }}" style="color: inherit; text-decoration: none; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis;">{{ $titre }}</a>
          </h2>
        </header>
        {{- if $description }}
        <div class="entry-content">
          <p>{{ $description | markdownify | truncate 200 }}</p>
        </div>
        {{- end }}
        <footer class="entry-footer">
          {{- $metaItems := slice }}
          {{- if gt $nbChapitres 0 }}
            {{- $metaItems = $metaItems | append (printf "<span>%d %s</span>" $nbChapitres (cond (eq $nbChapitres 1) "chapitre" "chapitres")) }}
          {{- end }}
          {{- if gt $sectionReadingTime 0 }}
            {{- $metaItems = $metaItems | append (printf "<span>%d %s de lecture</span>" $sectionReadingTime (cond (eq $sectionReadingTime 1) "minute" "minutes")) }}
          {{- end }}
          {{- if $lastModified }}
            {{- $metaItems = $metaItems | append (printf "<span>Mis à jour le %s</span>" ($lastModified.Format "02/01/2006")) }}
          {{- end }}
          {{- if $metaItems }}
            {{- delimit $metaItems "&nbsp;·&nbsp;" | safeHTML }}
          {{- end }}
        </footer>
      </div>
      <a class="entry-link" aria-label="link to {{ $titre | plainify }}" href="{{ $lien }}"></a>
    </article>
    {{- else }}
      {{- /* Afficher le livre avec les métadonnées seulement si la section n'est pas trouvée */}}
      {{- $titre := .title }}
      {{- $description := .description }}
      {{- $lien := printf "/resources/%s/" .slug | absURL }}
      {{- $coverImage := "" }}
      {{- if .cover.image }}
        {{- $coverImageName := .cover.image }}
        {{- $globalCover := resources.Get (printf "livres/%s" $coverImageName) }}
        {{- if $globalCover }}
          {{- $coverImage = $globalCover.Permalink }}
        {{- else }}
          {{- $coverImage = (printf "/livres/%s" $coverImageName) | absURL }}
        {{- end }}
      {{- end }}
    
    <article class="post-entry" style="display: flex; gap: var(--gap); align-items: flex-start; margin-bottom: var(--gap);">
      {{- if $coverImage }}
      <figure class="entry-cover" style="flex-shrink: 0; width: 160px; margin: 0;">
        <img loading="lazy" src="{{ $coverImage }}" alt="{{ $titre | plainify }}" style="width: 100%; height: auto; border-radius: 4px; display: block;">
      </figure>
      {{- end }}
      <div style="flex: 1; min-width: 0;">
        <header class="entry-header">
          <h2 class="entry-hint-parent" style="gap: 12px; align-items: baseline;">
            <a href="{{ $lien }}" style="color: inherit; text-decoration: none; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis;">{{ $titre }}</a>
          </h2>
        </header>
        {{- if $description }}
        <div class="entry-content">
          <p>{{ $description | markdownify | truncate 200 }}</p>
        </div>
        {{- end }}
      </div>
      <a class="entry-link" aria-label="link to {{ $titre | plainify }}" href="{{ $lien }}"></a>
    </article>
    {{- end }}
  {{- end }}
{{- else }}
<div class="post-content">
  <p>Aucun livre disponible pour le moment.</p>
</div>
{{- end }}

{{- end }}{{- /* fin du else pour la page principale */ -}}
{{- end }}{{- /* end main */ -}}
