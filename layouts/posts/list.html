{{- define "main" }}

<header class="page-header">
  {{- partial "breadcrumbs.html" . }}
  <h1>{{ .Title }}</h1>
  {{- if .Description }}
  <div class="post-description">
    {{ .Description | markdownify }}
  </div>
  {{- end }}
</header>

{{- if .Content }}
<div class="post-content">
  {{- if not (.Param "disableAnchoredHeadings") }}
  {{- partial "anchored_headings.html" .Content -}}
  {{- else }}{{ .Content }}{{ end }}
</div>
{{- end }}

{{- /* Filtres */ -}}
<div class="filters" style="margin-bottom: calc(var(--gap) * 1.5); padding: 20px; background: var(--entry); border: 1px solid var(--border); border-radius: 8px;">
  <div>
    <strong style="display: block; margin-bottom: 12px;">Filtrer par pilier :</strong>
    <div class="filter-buttons pillar-filters" style="display: flex; flex-wrap: wrap; gap: 8px;">
      <button class="filter-button active" data-filter="all" style="padding: 8px 16px; background: var(--primary); color: var(--theme); border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: var(--transition);">
        Tous
      </button>
      <button class="filter-button" data-filter="role-cto" style="padding: 8px 16px; background: var(--code-bg); color: var(--primary); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; transition: var(--transition);">
        Le rôle du CTO
      </button>
      <button class="filter-button" data-filter="gouvernance-decision" style="padding: 8px 16px; background: var(--code-bg); color: var(--primary); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; transition: var(--transition);">
        Gouvernance & décision
      </button>
      <button class="filter-button" data-filter="culture-management" style="padding: 8px 16px; background: var(--code-bg); color: var(--primary); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; transition: var(--transition);">
        Culture & management
      </button>
      <button class="filter-button" data-filter="trouver-sa-place" style="padding: 8px 16px; background: var(--code-bg); color: var(--primary); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; transition: var(--transition);">
        Trouver sa place
      </button>
    </div>
  </div>

  <div id="filter-count" style="margin-top: 16px; color: var(--secondary); font-size: 14px;"></div>
</div>

{{- /* Liste des articles */ -}}
<div id="posts-container">
{{- $pages := .RegularPages }}
{{- range $pages }}
<article class="post-entry" data-pillar="{{ with .Params.pillar }}{{ . }}{{ end }}">
  {{- $isHidden := (.Param "cover.hiddenInList") | default (.Param "cover.hidden") | default false }}
  {{- partial "cover.html" (dict "cxt" . "IsSingle" false "isHidden" $isHidden) }}
  <header class="entry-header">
    <h2 class="entry-hint-parent">
      {{ .Title }}
      {{- if .Draft }}
      <span class="entry-hint" title="Draft">
        <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" fill="currentColor">
          <path d="M160-410v-60h300v60H160Zm0-165v-60h470v60H160Zm0-165v-60h470v60H160Zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22q0 11-4.5 22.5T862.09-380L643-160H520Zm300-263-37-37 37 37ZM580-220h38l121-122-18-19-19-18-122 121v38Zm141-141-19-18 37 37-18-19Z" />
        </svg>
      </span>
      {{- end }}
    </h2>
  </header>
  {{- if (ne (.Param "hideSummary") true) }}
  <div class="entry-content">
    <p>{{ .Summary | plainify | htmlUnescape }}{{ if .Truncated }}...{{ end }}</p>
  </div>
  {{- end }}
  {{- if not (.Param "hideMeta") }}
  <footer class="entry-footer">
    {{- partial "post_meta.html" . -}}
  </footer>
  {{- end }}
  <a class="entry-link" aria-label="post link to {{ .Title | plainify }}" href="{{ .Permalink }}"></a>
</article>
{{- end }}
</div>

{{- /* Script de filtrage */ -}}
<script>
(function() {
  const filterButtons = document.querySelectorAll('.filter-button');
  const posts = document.querySelectorAll('.post-entry');
  const filterCount = document.getElementById('filter-count');

  let activePillar = 'all';

  function updateCount() {
    const visiblePosts = document.querySelectorAll('.post-entry:not([style*="display: none"])');
    const total = posts.length;
    const visible = visiblePosts.length;

    if (activePillar === 'all') {
      filterCount.textContent = `${total} articles`;
    } else {
      filterCount.textContent = `${visible} article${visible > 1 ? 's' : ''} sur ${total}`;
    }
  }

  function applyFilters() {
    posts.forEach(post => {
      const postPillar = post.getAttribute('data-pillar') || '';

      if (activePillar === 'all' || postPillar === activePillar) {
        post.style.display = '';
      } else {
        post.style.display = 'none';
      }
    });

    updateCount();
  }

  filterButtons.forEach(button => {
    button.addEventListener('click', function() {
      const filter = this.getAttribute('data-filter');

      activePillar = filter;

      // Réinitialiser tous les boutons
      document.querySelectorAll('.filter-button').forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = 'var(--code-bg)';
        btn.style.color = 'var(--primary)';
        btn.style.border = '1px solid var(--border)';
      });

      // Activer le bouton cliqué
      this.classList.add('active');
      this.style.background = 'var(--primary)';
      this.style.color = 'var(--theme)';
      this.style.border = 'none';

      applyFilters();
    });
  });

  // Initialiser le compteur
  updateCount();
})();
</script>

<style>
.filter-button:hover {
  background: var(--border) !important;
}

.filter-button.active:hover {
  background: var(--primary) !important;
}

@media screen and (max-width: 768px) {
  .filters {
    padding: 16px !important;
  }

  .filter-buttons {
    gap: 6px !important;
  }

  .filter-button {
    padding: 6px 12px !important;
    font-size: 14px !important;
  }
}
</style>

{{- end }}{{- /* end main */ -}}
